---
id: Ecosystem
title: Ecosystem
---

import { Legend, Item, Link, Tabs, Ts, tab1, tab2 } from '@site/src/all'

The ecosystem is an isolated atom environment. Every ecosystem creates:

- A scheduler for intelligently running atom-related tasks.
- A graph that manages atom dependencies.
- A [SelectorCache](SelectorCache) for managing cached [Atom Selectors](../types/AtomSelector).
- An id generator that generates unique ids for unnamed Atom Selectors and external graph nodes.

The Ecosystem class itself defines many methods for creating, destroying, and inspecting atom instances and the graph they form.

Ecosystems can be used completely outside of React. This can be helpful for testing atoms.

## Creation

Create ecosystems with [the `createEcosystem()` factory](../factories/createEcosystem).

```ts
import { createEcosystem } from '@zedux/react'

const rootEcosystem = createEcosystem({ id: 'root' })
```

Ecosystems are also created automatically when using an [`<EcosystemProvider>`](../components/EcosystemProvider) without passing an `ecosystem` prop:

```tsx
import { EcosystemProvider } from '@zedux/react'

function App() {
  return (
    <EcosystemProvider id="root">
      <Routes />
    </EcosystemProvider>
  )
}
```

Additionally, the [global ecosystem](../../walkthrough/ecosystems#global) will be created automatically if atoms are used in React outside any `<EcosystemProvider>`.

## Providing

Ecosystems can take control of all atom usages in a React component tree by wrapping the tree in [`<EcosystemProvider>`](../components/EcosystemProvider).

```tsx
function App() {
  return (
    <EcosystemProvider ecosystem={rootEcosystem}>
      <Routes />
    </EcosystemProvider>
  )
}
```

## Modifying Overrides

The ability to swap out atom implementations on the fly is one of Zedux' superpowers. Use [`.addOverrides`](#addoverrides), [`.removeOverrides`](#removeoverrides), or [`.setOverrides`](#setoverrides).

```tsx live ecosystemId=Ecosystem/modifying-overrides resultVar=Swapper
const one = atom('common-key', () => 'Numero Uno')
const two = atom('common-key', () => 'I am the best')
const three = atom('common-key', () => 'Two is not the best')

function Swapper() {
  const ecosystem = useEcosystem()
  const state = useAtomValue(one)

  return (
    <>
      <div>Current State: {state}</div>
      <button onClick={() => ecosystem.setOverrides([one])}>Use One</button>
      <button onClick={() => ecosystem.setOverrides([two])}>Use Two</button>
      <button onClick={() => ecosystem.setOverrides([three])}>Use Three</button>
    </>
  )
}
```

## Properties

All properties are readonly!

<Legend>
  <Item name="selectorCache">
    <p>
      The <Link to="SelectorCache">SelectorCache</Link> class instance that
      tracks all cached atom selectors in this ecosystem.
    </p>
  </Item>
  <Item name="complexAtomParams">
    <p>
      A boolean. This is set to the <code>complexAtomParams</code> value you
      passed via <Link to="../types/EcosystemConfig">EcosystemConfig</Link> when
      creating this ecosystem. If not specified, defaults to false.
    </p>
    <p>
      Whether to allow non-serializable values as atom params. See{' '}
      <Link to="../../advanced/complex-params">the complex params guide</Link>.
    </p>
  </Item>
  <Item name="complexSelectorParams">
    <p>
      A boolean. This is set to the <code>complexSelectorParams</code> value you
      passed via <Link to="../types/EcosystemConfig">EcosystemConfig</Link> when
      creating this ecosystem. If not specified, defaults to false.
    </p>
    <p>
      Whether to allow non-serializable values as atom selector arguments. See{' '}
      <Link to="../../advanced/complex-params">the complex params guide</Link>.
    </p>
  </Item>
  <Item name="consumeHydrations">
    <p>
      A boolean. This is set to the <code>consumeHydrations</code> value you
      passed via <Link to="../types/EcosystemConfig">EcosystemConfig</Link> when
      creating this ecosystem. If not specified, defaults to false.
    </p>
    <p>
      Whether a key-value pair passed to <code>ecosystem.hydrate()</code> should
      be removed from the ecosystem's hydration the first time it's used.
    </p>
  </Item>
  <Item name="context">
    <p>
      An object. May be undefined. A reference to the `context` object passed to
      <Link to="../factories/createEcosystem">
        the <code>createEcosystem()</code> factory
      </Link> (if any) or the latest <Link to="#reset">
        <code>.reset</code>
      </Link> call. This object should be constant until the ecosystem is reset via
      <code>.reset()</code>.
    </p>
    <p>
      When <code>.reset()</code> is called, the previous context (if any) will
      be passed as the second parameter to{' '}
      <Link to="../types/EcosystemConfig#onready">
        the <code>onReady</code> function
      </Link>{' '}
      as part of the reset.
    </p>
  </Item>
  <Item name="defaultTtl">
    <p>
      A number. May be undefined. The default ttl to use for all atom instances
      in the ecosystem.
    </p>
    <p>
      The default is <code>undefined</code>, which means all atom instances will
      live forever.
    </p>
  </Item>
  <Item name="id">
    <p>
      A string. The id of this ecosystem as set via{' '}
      <Link to="../types/EcosystemConfig">EcosystemConfig</Link> when creating
      this ecosystem. The string <code>'@@global'</code> is reserved for the
      global ecosystem.
    </p>
    <p>
      If you didn't specify an id when creating this ecosystem, this will be a
      randomly-generated string.
    </p>
  </Item>
  <Item name="flags">
    <p>
      An array of strings. These work in conjunction with{' '}
      <Link to="Atom#flags">atom flags</Link> to raise warnings when unsafe
      atoms are not overridden in certain environments.
    </p>
    <p>
      If an atom has a flag that is not present in this array, Zedux will log a
      warning.
    </p>
    <p>
      Flag checking is off by default - simply don't pass a flags array to{' '}
      <code>createEcosystem()</code> and Zedux will ignore all flags. To turn it
      on, but with no flags, pass an empty array.
    </p>
    <Ts>{`
createEcosystem() // flag checking disabled. Zedux will ignore all atom flags.
createEcosystem({ flags: [] }) // flag checking enabled! All flags will log warnings
createEcosystem({ flags: ['a'] }) // all atom flags except 'a' will log warnings
`}</Ts>
    <p>
      Which atoms, which flags, and which environments, is all up to you. You
      may want to flag atoms that run side effects you don't want to run in
      tests. Or you may want to flag atoms that use APIs that only work in the
      browser or in electron or any other environment.
    </p>
  </Item>
  <Item name="hydration">
    <p>
      An object. May be undefined. The shallowly merged result of all calls to{' '}
      <code>ecosystem.hydrate()</code>.
    </p>
  </Item>
  <Item name="modBus">
    <p>
      A <Link to="Store">Zedux Store</Link>. This store has no state. It serves
      only as a message bus for notifying plugins of mod events.
    </p>
    <p>
      See <Link to="../../advanced/plugins">the plugins guide</Link>.
    </p>
  </Item>
  <Item name="overrides">
    <p>
      An object mapping atom keys to atoms. These are the currently-overridden
      atoms in this ecosystem. Modify this list by calling{' '}
      <code>ecosystem.setOverrides()</code>,{' '}
      <code>ecosystem.addOverrides()</code>, and{' '}
      <code>ecosystem.removeOverrides()</code>.
    </p>
  </Item>
  <Item name="ssr">
    <p>
      A boolean. Whether the ecosystem is being used on the server to generate
      SSR content.{' '}
    </p>
    <p>
      This is set to the <code>ssr</code> value you passed via{' '}
      <Link to="../types/EcosystemConfig">EcosystemConfig</Link> when creating
      this ecosystem. If not specified, defaults to false.
    </p>
    <p>
      Currently the only thing this affects is <code>injectEffect()</code> - SSR
      mode prevents effects from running at all in this ecosystem.
    </p>
  </Item>
</Legend>

## Methods

The ecosystem class has the following public methods:

### `.addOverrides`

Adds new overrides to the current list of overrides and/or swaps out currently-overridden atoms with different implementations. All existing instances of atoms in the passed list will be force-destroyed, allowing their dependents to recreate them.

#### Signature

```ts
.addOverrides(overrides) => void
```

#### `overrides`

Required. An array of [atoms](Atom).

### `.destroy`

Destroys all atom instances in the ecosystem, cleans up the ecosystem itself (e.g. by removing all currently scheduled tasks), and removes it from the [internalStore](../constants/internalStore).

#### Signature

```ts
.destroy(force?) => void
```

#### `force`

Optional. A boolean. Default: `false`. If true, will destroy the ecosystem even if it's currently being provided over React context (via `<EcosystemProvider>`).

### `.inspectInstances`

Returns a list of instances that match the given atom.

#### Example

```ts
const exampleAtom = atom('example', (param: string) => param)

myEcosystem.getInstance(exampleAtom, ['a'])
myEcosystem.getInstance(exampleAtom, ['b'])

myEcosystem.inspectInstances(exampleAtom)
// [<AtomInstance with params ['a']>, <AtomInstance with params ['b']>]
myEcosystem.inspectInstances('my')
// [<AtomInstance with params ['a']>, <AtomInstance with params ['b']>]
```

#### Signature

```ts
.inspectInstances(atom)
```

#### Overloads

```ts
.inspectInstances(key)
```

#### `atom`

Required. An atom, all instances of which will be returned.

#### `key`

Required (in this overload). A string. Instances whose [atom's `key`](Atom#key) match this string will be returned.

### `.get`

Returns the current state of an atom instance. Creates the atom instance if it doesn't exist yet. The atom instance to use will be resolved based on the passed atom and params.

#### Signature

```ts
.get(atom, params?) => value
```

#### Overloads

```ts
.get(instance) => value
```

#### `atom`

Required. The [atom](Atom) object whose key will be used to find an existing atom instance and whose definition will be used to create an atom instance if none exist yet.

#### `params`

Optional. An array of parameters that identify this atom instance. These params will be passed to the atom's [evaluator function](../glossary#evaluator).

TS users will be required to pass this for atoms that take params. If you don't use TS ... just don't forget to pass them.

#### `instance`

Required. An atom instance whose value we're getting. This overload is just an alias for [`instance.getState()`](AtomInstance#getstate).

#### Example

```ts
const currentValue = rootEcosystem.get(myAtom)
const withParams = rootEcosystem.get(paramsAtom, ['param 1', 'param 2'])
```

### `.getInstance`

Returns an atom instance. Creates the atom instance if it doesn't exist yet. The atom instance to use will be resolved based on the passed atom and params.

#### Signature

```ts
.getInstance(atom, params?) => value
```

#### `atom`

Required. The [atom](Atom) object whose key will be used to find an existing atom instance and whose definition will be used to create an atom instance if none exist yet.

#### `params`

Optional. An array of parameters that identify this atom instance. These params will be passed to the atom's [evaluator function](../glossary#evaluator).

TS users will be required to pass this for atoms that take params. If you don't use TS ... just don't forget to pass them.

#### Example

```ts
const instance = rootEcosystem.getInstance(myAtom)
const withParams = rootEcosystem.getInstance(paramsAtom, ['param 1', 'param 2'])

instance.getState()
instance.setState('new state')
```

### `.inspectInstanceValues`

Returns an object mapping the [keyHash](AtomInstance#keyhash) of all atom instances in the ecosystem to their current values.

#### Signature

```ts
.inspectInstanceValues(atom?) => object
```

#### Overloads

```ts
.inspectInstanceValues(searchKey?) => object
```

#### `atom`

Optional. An atom object to filter results by. Only instances of the atom will included in the result.

#### `searchKey`

Optional. A string to filter results by. Only atom instances whose [atom's key](Atom#key) or whose own [keyHash](AtomInstance#keyhash) match the searchKey will be included in the result.

### `.reset`

The preferred way to clear an ecosystem's state. Calling `.reset` will call [`.wipe()`](#wipe) but will also rerun [the `onReady` function](../types/EcosystemConfig#onready).

#### Signature

```ts
.reset(newContext?) => void
```

#### `newContext`

Optional. An object. The new context to set on this ecosystem. If not passed, the existing context (if any) will be reused. The ecosystem's `context` property will be set to this before `onReady` is called. The previous context will be passed to `onReady` as the second parameter.

```ts
const myEcosystem = createEcosystem({
  context: { someField: 'some val' },
  id: 'my',
  onReady: (ecosystem, prevContext) =>
    console.log('old context:', prevContext, 'new context:', ecosystem.context),
})
// old context: undefined new context: { someField: 'some val' }

myEcosystem.reset({ someField: 'new val' })
// old context: { someField: 'some val' } new context: { someField: 'new val' }
```

### `.removeOverrides`

Removes atoms from the ecosystem's list of overrides. All instances of atoms in the passed list will be force-destroyed, allowing their dependencies to recreate them using the no-longer-overridden implementations.

#### Signature

```ts
.removeOverrides(overrides) => void
```

#### `overrides`

Required. An array of [atoms](Atom) and/or string keys.

### `.select`

Runs an [AtomSelector](../types/AtomSelector) statically (without creating any dependencies). Returns the result. Will create any atom instances used in the AtomSelector that haven't been created yet.

#### Signature

```ts
.select(atomSelectorOrConfig, ...args) => result
```

#### `atomSelectorOrConfig`

The [AtomSelector](../types/AtomSelector) to run or an [AtomSelectorConfig object](../types/AtomSelector#atomselectorconfig) with the AtomSelector as the `selector` property.

#### `args`

The extra arguments to pass to the AtomSelector (besides the first AtomGetters arg, which Zedux passes for you). In TypeScript, all of the AtomSelector's required arguments are required here.

#### `result`

Whatever the AtomSelector returns.

### `.setOverrides`

Replaces the ecosystem's list of overridden atoms with the passed overrides. All instances of atoms in either the new or old lists will be force-destroyed, allowing their dependencies to recreate them.

To selectively update only certain atoms in the list, use [`.addOverrides`](#addoverrides) or [`.removeOverrides`](#removeoverrides).

#### Signature

```ts
.setOverrides(newOverrides) => void
```

#### `newOverrides`

Required. An array of [atoms](Atom). Will be set as the new [`.overrides`](#overrides) property.
